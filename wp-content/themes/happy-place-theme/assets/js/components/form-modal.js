/**
 * Simple Modal System - Happy Place Framework
 *
 * Handles modal triggers with minimal complexity
 * Works with existing modal HTML generated by custom-form-modal.php
 *
 * @package HappyPlaceTheme
 * @since 3.3.0
 */

document.addEventListener('DOMContentLoaded', function() {
    // CRITICAL FIX: Ensure modal CSS is loaded
    function ensureModalCSS() {
        // Test if modal CSS is working
        const testModal = document.querySelector('.hph-modal');
        if (testModal) {
            testModal.classList.add('active');
            const computedStyle = getComputedStyle(testModal);

            if (computedStyle.display !== 'flex') {
                console.log('Simple Modal System: CSS not loaded, injecting fallback');

                // Inject critical modal CSS
                const style = document.createElement('style');
                style.setAttribute('data-modal-fallback', 'true');
                style.textContent = `
                    .hph-modal.active,
                    .hph-lightbox.active {
                        display: flex !important;
                        position: fixed !important;
                        top: 0 !important;
                        left: 0 !important;
                        width: 100% !important;
                        height: 100% !important;
                        background: rgba(0, 0, 0, 0.5) !important;
                        z-index: 10000 !important;
                        align-items: center !important;
                        justify-content: center !important;
                        animation: modalFadeIn 0.3s ease !important;
                    }

                    .hph-modal-content {
                        background: white !important;
                        border-radius: 8px !important;
                        padding: 2rem !important;
                        max-width: 90% !important;
                        max-height: 90% !important;
                        overflow-y: auto !important;
                        position: relative !important;
                    }

                    @keyframes modalFadeIn {
                        from { opacity: 0; transform: scale(0.95); }
                        to { opacity: 1; transform: scale(1); }
                    }
                `;
                document.head.appendChild(style);
                console.log('Simple Modal System: Fallback CSS injected');
            }

            testModal.classList.remove('active');
        }
    }

    // Run CSS check immediately
    ensureModalCSS();

    // Find all modal triggers
    const triggers = document.querySelectorAll('.modal-trigger, [data-modal-form]');

    // Add click handlers to all triggers
    triggers.forEach(trigger => {
        trigger.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            // Determine which modal to open
            let modalId = 'hph-form-modal'; // default

            // Check for specific modal ID
            if (trigger.dataset.modalId) {
                modalId = trigger.dataset.modalId;
            }

            // Find the modal
            const modal = document.getElementById(modalId);
            if (!modal) {
                return;
            }

            // Update modal title/subtitle if provided
            const titleElement = modal.querySelector('.hph-modal-title');
            const subtitleElement = modal.querySelector('.hph-modal-subtitle-section p');

            if (titleElement && trigger.dataset.modalTitle) {
                titleElement.textContent = trigger.dataset.modalTitle;
            }

            if (subtitleElement && trigger.dataset.modalSubtitle) {
                subtitleElement.textContent = trigger.dataset.modalSubtitle;
            }

            // Open the modal
            openModal(modal);
        });
    });

    // Simple modal open function
    function openModal(modal) {
        // Add active class (triggers CSS display: flex)
        modal.classList.add('active');
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
    }

    // Simple modal close function
    function closeModal(modal) {
        console.log('Simple Modal System: Closing modal');

        modal.classList.remove('active');
        document.body.style.overflow = '';
    }

    // Handle close events (clicks on backdrop or close buttons)
    document.addEventListener('click', function(e) {
        // Check if clicked on close button or backdrop
        if (e.target.matches('[data-modal-close]') ||
            e.target.closest('[data-modal-close]') ||
            e.target.classList.contains('hph-modal-backdrop')) {

            // Find the active modal
            const activeModal = document.querySelector('.hph-modal.active');
            if (activeModal) {
                closeModal(activeModal);
            }
        }
    });

    // Handle ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const activeModal = document.querySelector('.hph-modal.active');
            if (activeModal) {
                closeModal(activeModal);
            }
        }
    });

    // Global functions for external use
    window.openHphFormModal = function(modalId = 'hph-form-modal') {
        const modal = document.getElementById(modalId);
        if (modal) {
            openModal(modal);
        }
    };

    window.closeHphFormModal = function(modalId = null) {
        if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                closeModal(modal);
            }
        } else {
            const activeModal = document.querySelector('.hph-modal.active');
            if (activeModal) {
                closeModal(activeModal);
            }
        }
    };

    // Backward compatibility
    window.openCustomModal = window.openHphFormModal;
    window.openFelloModal = () => window.openHphFormModal('hph-fello-modal');
    window.openConsultationModal = () => window.openHphFormModal('hph-consultation-modal');

    console.log('Simple Modal System: Ready');
});