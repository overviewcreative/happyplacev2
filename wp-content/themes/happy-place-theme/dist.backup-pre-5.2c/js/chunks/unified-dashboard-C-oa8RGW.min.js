window.HPH?(HPH.register("crud",function(){return{init:function(e){this.initCreateForms(e),this.initEditForms(e),this.initDeleteButtons(e),this.initBulkActions(e)},initCreateForms:function(e){e.querySelectorAll('.add-listing, .add-lead, .create-new, [data-action="create"]').forEach(a=>{a.addEventListener("click",o=>{o.preventDefault(),this.openCreateModal(a.dataset.type||"listing")})})},initEditForms:function(e){e.querySelectorAll('.edit-listing, .edit-lead, .edit-item, [data-action="edit"]').forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const n=a.dataset.id,i=a.dataset.type||"listing";this.openEditModal(i,n)})})},initDeleteButtons:function(e){e.querySelectorAll('.delete-listing, .delete-lead, .delete-item, [data-action="delete"]').forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const n=a.dataset.id,i=a.dataset.type||"listing";this.confirmDelete(i,n,a)})})},initBulkActions:function(e){e.querySelectorAll(".bulk-actions-form, .dashboard-bulk-actions").forEach(a=>{const o=a.querySelector(".select-all"),n=a.querySelectorAll('input[type="checkbox"][name="items[]"]');a.querySelector(".bulk-action-select");const i=a.querySelector(".bulk-action-submit");o&&o.addEventListener("change",()=>{n.forEach(r=>r.checked=o.checked),this.updateBulkControls(a)}),n.forEach(r=>{r.addEventListener("change",()=>this.updateBulkControls(a))}),i&&i.addEventListener("click",r=>{r.preventDefault(),this.processBulkAction(a)})})},updateBulkControls:function(e){const t=e.querySelectorAll('input[type="checkbox"][name="items[]"]:checked'),a=e.querySelector(".bulk-actions");a&&(a.style.display=t.length>0?"block":"none")},openCreateModal:function(e){window.HPH.modules.modals&&window.HPH.modules.modals.open("create-".concat(e,"-modal"),{title:"Add New ".concat(e.charAt(0).toUpperCase()+e.slice(1)),onSave:t=>this.createItem(e,t)})},openEditModal:function(e,t){this.loadItemData(e,t).then(a=>{window.HPH.modules.modals&&window.HPH.modules.modals.open("edit-".concat(e,"-modal"),{title:"Edit ".concat(e.charAt(0).toUpperCase()+e.slice(1)),data:a,onSave:o=>this.updateItem(e,t,o)})})},loadItemData:function(e,t){return window.HPH.ajax.request({action:"hph_get_".concat(e,"_details"),id:t,nonce:window.hphNonce||""}).then(a=>a.data||{})},createItem:function(e,t){const a=new FormData;return a.append("action","hph_create_".concat(e)),a.append("nonce",window.hphNonce||""),Object.keys(t).forEach(o=>{a.append(o,t[o])}),window.HPH.ajax.submitForm(null,{data:a,onSuccess:o=>{this.handleCrudSuccess(e,"created",o),this.refreshDashboard()},onError:o=>this.handleCrudError(e,"create",o)})},updateItem:function(e,t,a){const o=new FormData;return o.append("action","hph_update_".concat(e)),o.append("id",t),o.append("nonce",window.hphNonce||""),Object.keys(a).forEach(n=>{o.append(n,a[n])}),window.HPH.ajax.submitForm(null,{data:o,onSuccess:n=>{this.handleCrudSuccess(e,"updated",n),this.refreshDashboard()},onError:n=>this.handleCrudError(e,"update",n)})},confirmDelete:function(e,t,a){confirm("Are you sure you want to delete this ".concat(e,"?"))&&this.deleteItem(e,t,a)},deleteItem:function(e,t,a){const o=a.textContent;a.textContent="Deleting...",a.disabled=!0,window.HPH.ajax.request({action:"hph_delete_".concat(e),id:t,nonce:window.hphNonce||""}).then(n=>{this.handleCrudSuccess(e,"deleted",n);const i=a.closest("tr, .dashboard-item");i&&i.remove()}).catch(n=>{this.handleCrudError(e,"delete",n),a.textContent=o,a.disabled=!1})},processBulkAction:function(e){const t=Array.from(e.querySelectorAll('input[type="checkbox"][name="items[]"]:checked')),a=e.querySelector(".bulk-action-select").value;if(t.length===0){alert("Please select items to perform bulk action.");return}if(!a){alert("Please select an action.");return}const o=t.map(n=>n.value);this.executeBulkAction(a,o,e)},executeBulkAction:function(e,t,a){window.HPH.ajax.request({action:"hph_bulk_action",bulk_action:e,ids:t,nonce:window.hphNonce||""}).then(o=>{this.handleCrudSuccess("items",e,o),this.refreshDashboard()}).catch(o=>{this.handleCrudError("items",e,o)})},handleCrudSuccess:function(e,t,a){window.HPH.modules.notifications&&window.HPH.modules.notifications.show("".concat(e," ").concat(t," successfully!"),"success")},handleCrudError:function(e,t,a){window.HPH.modules.notifications&&window.HPH.modules.notifications.show("Error ".concat(t," ").concat(e,": ").concat(a.message||"Unknown error"),"error")},refreshDashboard:function(){const e=new CustomEvent("dashboardRefresh");document.dispatchEvent(e)}}}),HPH.register("dataTables",function(){return{instances:new Map,init:function(e){e.querySelectorAll(".dashboard-table, .data-table, .listings-table, .leads-table").forEach(a=>this.initTable(a))},initTable:function(e){if(e.dataset.hphInitialized)return;const t={sortable:e.dataset.sortable!=="false",filterable:e.dataset.filterable!=="false",paginated:e.dataset.paginated!=="false",perPage:parseInt(e.dataset.perPage)||20},a=this.createTable(e,t);this.instances.set(e.id||"table-"+Date.now(),a),e.dataset.hphInitialized="true"},createTable:function(e,t){const a={table:e,config:t,currentPage:1,sortColumn:null,sortDirection:"asc",filterText:""};return t.sortable&&this.initSorting(a),t.filterable&&this.initFiltering(a),t.paginated&&this.initPagination(a),a},initSorting:function(e){e.table.querySelectorAll("th[data-sortable]").forEach(a=>{a.style.cursor="pointer",a.addEventListener("click",()=>{const o=a.dataset.sortable;this.sortTable(e,o)})})},initFiltering:function(e){let t=e.table.parentNode.querySelector(".table-filter");t||(t=document.createElement("input"),t.type="text",t.className="table-filter",t.placeholder="Filter table...",e.table.parentNode.insertBefore(t,e.table)),t.addEventListener("input",a=>{e.filterText=a.target.value.toLowerCase(),this.applyFilter(e)})},initPagination:function(e){this.createPagination(e),this.updatePagination(e)},sortTable:function(e,t){e.sortColumn===t?e.sortDirection=e.sortDirection==="asc"?"desc":"asc":(e.sortColumn=t,e.sortDirection="asc");const a=Array.from(e.table.querySelectorAll("tbody tr"));a.sort((n,i)=>{var s,d;const r=((s=n.querySelector('[data-sort="'.concat(t,'"]')))==null?void 0:s.textContent)||"",c=((d=i.querySelector('[data-sort="'.concat(t,'"]')))==null?void 0:d.textContent)||"",l=r.localeCompare(c,void 0,{numeric:!0});return e.sortDirection==="asc"?l:-l});const o=e.table.querySelector("tbody");a.forEach(n=>o.appendChild(n)),this.updateSortHeaders(e)},updateSortHeaders:function(e){e.table.querySelectorAll("th[data-sortable]").forEach(a=>{const o=a.dataset.sortable===e.sortColumn;a.classList.toggle("sort-active",o),a.classList.toggle("sort-asc",o&&e.sortDirection==="asc"),a.classList.toggle("sort-desc",o&&e.sortDirection==="desc")})},applyFilter:function(e){e.table.querySelectorAll("tbody tr").forEach(a=>{const o=a.textContent.toLowerCase(),n=!e.filterText||o.includes(e.filterText);a.style.display=n?"":"none"})},createPagination:function(e){const t=document.createElement("div");t.className="table-pagination",e.table.parentNode.appendChild(t),e.paginationContainer=t},updatePagination:function(e){const t=Array.from(e.table.querySelectorAll("tbody tr")).filter(o=>o.style.display!=="none"),a=Math.ceil(t.length/e.config.perPage);t.forEach((o,n)=>{const i=(e.currentPage-1)*e.config.perPage,r=i+e.config.perPage;o.style.display=n>=i&&n<r?"":"none"}),this.renderPaginationControls(e,a)},renderPaginationControls:function(e,t){if(t<=1){e.paginationContainer.innerHTML="";return}let a='<div class="pagination-controls">';e.currentPage>1&&(a+='<button class="page-btn" data-page="'.concat(e.currentPage-1,'">‹ Previous</button>'));for(let o=1;o<=t;o++){const n=o===e.currentPage;a+='<button class="page-btn '.concat(n?"active":"",'" data-page="').concat(o,'">').concat(o,"</button>")}e.currentPage<t&&(a+='<button class="page-btn" data-page="'.concat(e.currentPage+1,'">Next ›</button>')),a+="</div>",e.paginationContainer.innerHTML=a,e.paginationContainer.querySelectorAll(".page-btn").forEach(o=>{o.addEventListener("click",()=>{e.currentPage=parseInt(o.dataset.page),this.updatePagination(e)})})}}}),HPH.register("modals",function(){return{activeModal:null,init:function(e){this.createModalContainer(),this.initModalTriggers(e)},createModalContainer:function(){if(document.getElementById("hph-modal-container"))return;const e=document.createElement("div");e.id="hph-modal-container",e.className="hph-modal-overlay",e.innerHTML='\n                    <div class="hph-modal">\n                        <div class="hph-modal-header">\n                            <h3 class="hph-modal-title"></h3>\n                            <button class="hph-modal-close" aria-label="Close modal">&times;</button>\n                        </div>\n                        <div class="hph-modal-body"></div>\n                        <div class="hph-modal-footer">\n                            <button class="hph-btn hph-btn-secondary hph-modal-cancel">Cancel</button>\n                            <button class="hph-btn hph-btn-primary hph-modal-save">Save</button>\n                        </div>\n                    </div>\n                ',document.body.appendChild(e),e.querySelector(".hph-modal-close").addEventListener("click",()=>this.close()),e.querySelector(".hph-modal-cancel").addEventListener("click",()=>this.close()),e.addEventListener("click",t=>{t.target===e&&this.close()})},initModalTriggers:function(e){e.querySelectorAll("[data-modal]").forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const n=a.dataset.modal;this.open(n,{trigger:a})})})},open:function(e,t={}){const a=document.getElementById("hph-modal-container"),o=a.querySelector(".hph-modal"),n=a.querySelector(".hph-modal-title");n.textContent=t.title||e.replace("-"," ").replace(/\b\w/g,i=>i.toUpperCase()),this.loadModalContent(e,t),a.style.display="flex",o.style.opacity="0",o.style.transform="scale(0.9)",requestAnimationFrame(()=>{o.style.transition="all 0.3s ease",o.style.opacity="1",o.style.transform="scale(1)"}),this.activeModal={id:e,options:t},document.body.style.overflow="hidden"},loadModalContent:function(e,t){const a=document.querySelector(".hph-modal-body"),o=document.querySelector(".hph-modal-save");e.includes("listing")?this.loadListingForm(a,t):e.includes("lead")?this.loadLeadForm(a,t):this.loadGenericForm(a,t),o.onclick=()=>{if(t.onSave){const n=this.collectFormData(a);t.onSave(n)}this.close()}},loadListingForm:function(e,t){e.innerHTML='\n                    <form class="modal-form">\n                        <div class="form-group">\n                            <label for="listing-title">Property Title</label>\n                            <input type="text" id="listing-title" name="title" required>\n                        </div>\n                        <div class="form-group">\n                            <label for="listing-price">Price</label>\n                            <input type="number" id="listing-price" name="price" required>\n                        </div>\n                        <div class="form-group">\n                            <label for="listing-address">Address</label>\n                            <input type="text" id="listing-address" name="address" required>\n                        </div>\n                        <div class="form-group">\n                            <label for="listing-description">Description</label>\n                            <textarea id="listing-description" name="description" rows="4"></textarea>\n                        </div>\n                    </form>\n                ',t.data&&this.populateForm(e.querySelector(".modal-form"),t.data)},loadLeadForm:function(e,t){e.innerHTML='\n                    <form class="modal-form">\n                        <div class="form-group">\n                            <label for="lead-name">Name</label>\n                            <input type="text" id="lead-name" name="name" required>\n                        </div>\n                        <div class="form-group">\n                            <label for="lead-email">Email</label>\n                            <input type="email" id="lead-email" name="email" required>\n                        </div>\n                        <div class="form-group">\n                            <label for="lead-phone">Phone</label>\n                            <input type="tel" id="lead-phone" name="phone">\n                        </div>\n                        <div class="form-group">\n                            <label for="lead-status">Status</label>\n                            <select id="lead-status" name="status">\n                                <option value="new">New</option>\n                                <option value="contacted">Contacted</option>\n                                <option value="qualified">Qualified</option>\n                                <option value="closed">Closed</option>\n                            </select>\n                        </div>\n                    </form>\n                ',t.data&&this.populateForm(e.querySelector(".modal-form"),t.data)},loadGenericForm:function(e,t){e.innerHTML="<p>Generic form content would go here</p>"},populateForm:function(e,t){Object.keys(t).forEach(a=>{const o=e.querySelector('[name="'.concat(a,'"]'));o&&(o.value=t[a])})},collectFormData:function(e){const t=e.querySelector(".modal-form");if(!t)return{};const a=new FormData(t);return Object.fromEntries(a.entries())},close:function(){const e=document.getElementById("hph-modal-container"),t=e.querySelector(".hph-modal");t.style.opacity="0",t.style.transform="scale(0.9)",setTimeout(()=>{e.style.display="none",document.body.style.overflow="",this.activeModal=null},300)}}}),HPH.register("analytics",function(){return{charts:new Map,init:function(e){this.initStatCards(e),this.initCharts(e),this.initReports(e)},initStatCards:function(e){e.querySelectorAll(".stat-card, .dashboard-stat").forEach(a=>this.enhanceStatCard(a))},enhanceStatCard:function(e){const t=e.querySelector(".stat-value"),a=t==null?void 0:t.dataset.target;a&&t&&this.animateNumber(t,0,parseInt(a),1e3)},animateNumber:function(e,t,a,o){const n=performance.now(),i=r=>{const c=r-n,l=Math.min(c/o,1),s=Math.floor(t+(a-t)*l);e.textContent=s.toLocaleString(),l<1&&requestAnimationFrame(i)};requestAnimationFrame(i)},initCharts:function(e){e.querySelectorAll(".chart, .analytics-chart").forEach(a=>this.createChart(a))},createChart:function(e){const t=e.dataset.chartType||"line",a=this.parseChartData(e),o=document.createElement("canvas");e.appendChild(o);const n={element:e,canvas:o,type:t,data:a};this.renderChart(n),this.charts.set(e.id||"chart-"+Date.now(),n)},parseChartData:function(e){try{return JSON.parse(e.dataset.chartData||"{}")}catch(t){return{labels:[],datasets:[]}}},renderChart:function(e){var n;const t=e.canvas.getContext("2d"),{width:a,height:o}=e.canvas.getBoundingClientRect();e.canvas.width=a,e.canvas.height=o,e.type==="line"&&((n=e.data.datasets)!=null&&n.length)&&this.drawLineChart(t,e.data,a,o)},drawLineChart:function(e,t,a,o){var c,l;const i=a-80,r=o-2*40;if(e.clearRect(0,0,a,o),e.strokeStyle="#3b82f6",e.lineWidth=2,(l=(c=t.datasets[0])==null?void 0:c.data)!=null&&l.length){const s=t.datasets[0].data,d=Math.max(...s),u=Math.min(...s),f=d-u||1;e.beginPath(),s.forEach((g,h)=>{const p=40+h/(s.length-1)*i,m=40+r-(g-u)/f*r;h===0?e.moveTo(p,m):e.lineTo(p,m)}),e.stroke()}},initReports:function(e){e.querySelectorAll(".generate-report, [data-report]").forEach(a=>{a.addEventListener("click",o=>{o.preventDefault();const n=a.dataset.report||"general";this.generateReport(n)})})},generateReport:function(e){window.HPH.ajax.request({action:"hph_generate_report",report_type:e,nonce:window.hphNonce||""}).then(t=>{t.download_url&&window.open(t.download_url,"_blank")}).catch(t=>{console.warn("Report generation failed:",t)})}}}),HPH.register("initDashboard",function(){return{init:function(e=document){window.HPH.modules.crud&&window.HPH.modules.crud.init(e),window.HPH.modules.dataTables&&window.HPH.modules.dataTables.init(e),window.HPH.modules.modals&&window.HPH.modules.modals.init(e),window.HPH.modules.analytics&&window.HPH.modules.analytics.init(e),this.initDashboardSpecific(e)},initDashboardSpecific:function(e){document.addEventListener("dashboardRefresh",()=>{this.refreshDashboardData()}),e.querySelectorAll(".auto-save-form").forEach(a=>{a.querySelectorAll("input, select, textarea").forEach(n=>{n.addEventListener("change",()=>{this.autoSaveForm(a)})})})},refreshDashboardData:function(){const e=document.querySelectorAll(".stat-card"),t=document.querySelectorAll(".dashboard-table");e.forEach(a=>{this.reloadStatCard(a)}),t.forEach(a=>{this.reloadTable(a)})},reloadStatCard:function(e){const t=e.dataset.endpoint;t&&window.HPH.ajax.request({action:t}).then(a=>{const o=e.querySelector(".stat-value");o&&a.value!==void 0&&(o.textContent=a.value)})},reloadTable:function(e){const t=e.dataset.endpoint;t&&window.HPH.ajax.request({action:t}).then(a=>{if(a.html){const o=e.querySelector("tbody");o.innerHTML=a.html}})},autoSaveForm:function(e){const t=new FormData(e);t.append("action","hph_auto_save"),t.append("nonce",window.hphNonce||""),window.HPH.ajax.submitForm(e,{data:t,onSuccess:()=>{this.showSaveIndicator(e)}})},showSaveIndicator:function(e){let t=e.querySelector(".save-indicator");t||(t=document.createElement("span"),t.className="save-indicator",t.textContent="Saved",e.appendChild(t)),t.style.opacity="1",setTimeout(()=>{t.style.opacity="0"},2e3)}}})):console.warn("HPH Core system not found. Dashboard modules require unified core.");window.hphDebug&&console.log("Unified Dashboard System Loaded - All CRUD/Analytics/Management redundancies eliminated");
