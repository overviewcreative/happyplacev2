window.HPH&&HPH.register("archiveUnified",function(r){return{currentView:"grid",currentPage:1,isLoading:!1,hasMorePages:!0,currentFilters:{},elements:{},init:function(){if(document.body.classList.contains("hph-map-view")){r.debug&&console.log("HPH Archive Unified System: Initializing map-specific functionality"),this.initMapView();return}this.cacheElements(),this.bindEvents(),this.initializeView(),this.loadSavedPreferences(),r.debug&&console.log("HPH Archive Unified System Initialized")},cacheElements:function(){this.elements={viewButtons:document.querySelectorAll("[data-view]"),viewContents:document.querySelectorAll("[data-view-content]"),filterForm:document.querySelector("#hero-search-form, .hph-search-form"),sortSelect:document.querySelector("[data-sort-select], #listings-sort"),searchInput:document.querySelector("#hero-search-input"),loadMoreBtn:document.querySelector("[data-load-more]"),loadMoreSection:document.querySelector(".hph-load-more-section"),gridContainer:document.querySelector('[data-listings-container="grid"]'),listContainer:document.querySelector('[data-listings-container="list"]'),mapContainer:document.querySelector('[data-view-content="map"]'),resultsCount:document.querySelector(".hph-results-count"),resultsInfo:document.querySelector(".hph-results-info")}},bindEvents:function(){if(this.elements.viewButtons.forEach(t=>{HPH.events.on(t,"click",i=>{i.preventDefault();const s=t.dataset.view;this.switchView(s)})}),this.elements.filterForm&&HPH.events.on(this.elements.filterForm,"submit",t=>{t.preventDefault(),this.handleFilterSubmit()}),this.elements.sortSelect&&HPH.events.on(this.elements.sortSelect,"change",t=>{this.handleSortChange(t.target.value)}),this.elements.loadMoreBtn&&HPH.events.on(this.elements.loadMoreBtn,"click",t=>{t.preventDefault(),this.loadMoreListings()}),this.elements.searchInput){let t;HPH.events.on(this.elements.searchInput,"input",i=>{clearTimeout(t),t=setTimeout(()=>{this.handleSearchInput(i.target.value)},500)})}const e=document.querySelector(".hph-map-panel-close");e&&HPH.events.on(e,"click",t=>{t.preventDefault(),this.switchView("grid")})},switchView:function(e){if(this.currentView!==e){switch(this.currentView=e,this.elements.viewButtons.forEach(t=>{const i=t.dataset.view===e;t.classList.toggle("active",i),t.setAttribute("aria-pressed",i)}),this.elements.viewContents.forEach(t=>{const i=t.dataset.viewContent===e;t.classList.toggle("active",i),t.style.display=i?"block":"none"}),e){case"map":this.redirectToMapView();return;case"grid":case"list":document.body.classList.remove("hph-map-view-active"),this.showElementsForStandardViews();break}this.saveViewPreference(e),HPH.events.trigger(document,"hph:viewChanged",{view:e})}},handleFilterSubmit:function(){if(this.isLoading)return;const e=new FormData(this.elements.filterForm),t={};for(let[i,s]of e.entries())s&&s!==""&&(t[i]=s);this.currentFilters=t,this.currentPage=1,this.loadListings({reset:!0})},handleSortChange:function(e){this.isLoading||(this.currentFilters.sort=e,this.currentPage=1,this.loadListings({reset:!0}))},handleSearchInput:function(e){this.isLoading||(e.length>=3||e.length===0)&&(this.currentFilters.s=e,this.currentPage=1,this.loadListings({reset:!0}))},loadMoreListings:function(){this.isLoading||!this.hasMorePages||(this.currentPage++,this.loadListings({append:!0}))},loadListings:function(e={}){var i,s;if(this.isLoading)return;this.isLoading=!0,this.showLoadingState(e.reset);const t={action:"hph_load_listings_unified",nonce:((i=window.hphArchive)==null?void 0:i.nonce)||"",page:this.currentPage,view:this.currentView,post_type:"listing",...this.currentFilters};fetch(((s=window.hphArchive)==null?void 0:s.ajaxUrl)||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(t)}).then(n=>n.json()).then(n=>{this.handleAjaxResponse(n,e)}).catch(n=>{console.error("Archive AJAX Error:",n),this.showError("Failed to load listings. Please try again.")}).finally(()=>{this.isLoading=!1,this.hideLoadingState()})},handleAjaxResponse:function(e,t){var a;if(!e.success){this.showError(((a=e.data)==null?void 0:a.message)||"Failed to load listings");return}const{html:i,pagination:s,count:n,view:o}=e.data;t.reset?this.replaceListings(i,o):t.append&&this.appendListings(i,o),this.updatePagination(s),this.updateResultsCount(n),this.updateURL(),HPH.events.trigger(document,"hph:listingsLoaded",{view:o,count:n,page:this.currentPage})},replaceListings:function(e,t){const i=t==="list"?this.elements.listContainer:this.elements.gridContainer;i&&(i.innerHTML=e,this.initializeNewListings(i))},appendListings:function(e,t){const i=t==="list"?this.elements.listContainer:this.elements.gridContainer;i&&(i.insertAdjacentHTML("beforeend",e),this.initializeNewListings(i))},initializeNewListings:function(e){e.querySelectorAll(".favorite-btn").forEach(i=>{var s;i.dataset.initialized||(i.dataset.initialized="true",(s=window.userSystem)!=null&&s.initFavoriteButtons&&window.userSystem.initFavoriteButtons())})},updatePagination:function(e){this.hasMorePages=e.has_more,this.elements.loadMoreBtn&&(this.elements.loadMoreBtn.style.display=this.hasMorePages?"block":"none"),this.elements.loadMoreSection&&(this.elements.loadMoreSection.style.display=this.hasMorePages?"block":"none")},updateResultsCount:function(e){if(this.elements.resultsCount&&(this.elements.resultsCount.textContent=e.total||"0"),this.elements.resultsInfo){const t=(this.currentPage-1)*(e.per_page||12)+1,i=Math.min(t+(e.per_page||12)-1,e.total||0);this.elements.resultsInfo.textContent="".concat(t,"-").concat(i," of ").concat(e.total||0," properties")}},updateURL:function(){const e=new URL(window.location);Object.keys(this.currentFilters).forEach(t=>{this.currentFilters[t]?e.searchParams.set(t,this.currentFilters[t]):e.searchParams.delete(t)}),e.searchParams.set("view",this.currentView),window.history.replaceState({},"",e.toString())},showLoadingState:function(e=!1){if(this.elements.loadMoreBtn){const t=this.elements.loadMoreBtn.querySelector(".hph-load-more-loading"),i=this.elements.loadMoreBtn.querySelector(".hph-load-more-text");t&&i&&(t.style.display="inline",i.style.display="none"),this.elements.loadMoreBtn.disabled=!0}e&&document.body.classList.add("hph-archive-loading")},hideLoadingState:function(){if(this.elements.loadMoreBtn){const e=this.elements.loadMoreBtn.querySelector(".hph-load-more-loading"),t=this.elements.loadMoreBtn.querySelector(".hph-load-more-text");e&&t&&(e.style.display="none",t.style.display="inline"),this.elements.loadMoreBtn.disabled=!1}document.body.classList.remove("hph-archive-loading")},showError:function(e){var n;const t=document.querySelector(".hph-archive-error");t&&t.remove();const i=document.createElement("div");i.className="hph-archive-error hph-alert hph-alert-error",i.innerHTML='\n                    <i class="fas fa-exclamation-triangle"></i>\n                    <span>'.concat(e,'</span>\n                    <button type="button" class="hph-alert-close" aria-label="Close">\n                        <i class="fas fa-times"></i>\n                    </button>\n                ');const s=((n=this.elements.gridContainer)==null?void 0:n.parentNode)||document.querySelector(".hph-listings-container");if(s){s.insertBefore(i,s.firstChild),setTimeout(()=>{i.parentNode&&i.remove()},5e3);const o=i.querySelector(".hph-alert-close");HPH.events.on(o,"click",()=>{i.remove()})}},redirectToMapView:function(){if(document.body.classList.contains("hph-map-view")||window.location.search.includes("view=map")){console.log("Already on map view, skipping redirect");return}const e=new URL(window.location);e.searchParams.set("view","map"),window.location.href=e.toString()},hideElementsForMapView:function(){document.querySelectorAll('[data-hide-in-views*="map"]').forEach(t=>{t.style.display="none"})},showElementsForStandardViews:function(){document.querySelectorAll('[data-hide-in-views*="map"]').forEach(t=>{t.style.display=""})},initializeView:function(){const t=new URLSearchParams(window.location.search).get("view");if(t&&["grid","list","map"].includes(t))this.switchView(t);else{const i=localStorage.getItem("hph_archive_view")||"grid";this.switchView(i)}},loadSavedPreferences:function(){try{const e=localStorage.getItem("hph_archive_view");e&&["grid","list","map"].includes(e)&&(this.currentView=e)}catch(e){}},saveViewPreference:function(e){try{localStorage.setItem("hph_archive_view",e)}catch(t){}},initMapView:function(){r.debug&&console.log("Initializing map view functionality..."),window.HPHArchiveMap={initializeMapView:()=>{this.initializeMapView()}},this.elements.mapContainer=document.getElementById("mapbox-listings-map"),this.elements.mapCards=document.querySelectorAll(".hph-map-card"),r.debug&&console.log("Map view elements cached:",{mapContainer:!!this.elements.mapContainer,cardsFound:this.elements.mapCards.length})},initializeMapView:function(){r.debug&&console.log("Starting map view initialization...");const e=this.elements.mapContainer||document.getElementById("mapbox-listings-map");if(!e){console.error("Map container not found");return}if(typeof mapboxgl>"u"){console.error("Mapbox GL JS not loaded");return}if(!window.hph_mapbox_config||!window.hph_mapbox_config.access_token){console.error("Mapbox configuration not available");return}if(!window.hphArchiveMap){console.error("Archive map data not available");return}typeof HPHMap<"u"?this.initializeClusteredMap(e):(console.warn("HPHMap class not available, using fallback"),this.initializeFallbackMap(e))},initializeClusteredMap:function(e){const t=window.hphArchiveMap,i=t.listings||[],s=t.center||[-75.1398,38.7816];try{const n=new HPHMap(e,{center:s,zoom:11,styleTheme:"professional",markerTheme:"happyPlace"});n.map.on("load",()=>{r.debug&&console.log("Map loaded, adding clustered markers for",i.length,"listings"),n.addListingMarkers(i,{enableClustering:t.enable_clustering!==!1,clusterRadius:t.cluster_radius||50,clusterMaxZoom:t.cluster_max_zoom||14,showPopup:!0,fitBounds:i.length>1});const o=e.querySelector(".hph-map-loading");o&&(o.style.display="none"),this.setupMapSidebarSync(n),r.debug&&console.log("Clustered map initialization complete")}),this.mapInstance=n}catch(n){console.error("Error initializing clustered map:",n),this.initializeFallbackMap(e)}},initializeFallbackMap:function(e){const t=window.hphArchiveMap,i=t.listings||[],s=t.center||[-75.1398,38.7816];try{mapboxgl.accessToken=window.hph_mapbox_config.access_token;const n=new mapboxgl.Map({container:e,style:"mapbox://styles/mapbox/light-v11",center:s,zoom:11});n.on("load",()=>{i.forEach(a=>{if(a.latitude&&a.longitude){const l=new mapboxgl.Marker({color:"#2563eb"}).setLngLat([a.longitude,a.latitude]).addTo(n),c=new mapboxgl.Popup({offset:25}).setHTML(this.createPopupHTML(a));l.setPopup(c)}});const o=e.querySelector(".hph-map-loading");o&&(o.style.display="none"),console.log("Fallback map initialized with",i.length,"listings")})}catch(n){console.error("Fallback map initialization failed:",n)}},setupMapSidebarSync:function(e){const t=this.elements.mapCards||document.querySelectorAll(".hph-map-card");t.forEach(i=>{i.addEventListener("click",s=>{const n=i.dataset.listingId;t.forEach(o=>o.classList.remove("active")),i.classList.add("active"),e&&e.highlightListingMarker&&e.highlightListingMarker(n)})}),document.addEventListener("hph-map-listing-click",i=>{const s=i.detail.listingId,n=document.querySelector('[data-listing-id="'.concat(s,'"]'));n&&(t.forEach(o=>o.classList.remove("active")),n.classList.add("active"),n.scrollIntoView({behavior:"smooth",block:"nearest"}))})},createPopupHTML:function(e){const t=e.price?"$".concat(Number(e.price).toLocaleString()):"",i=e.bedrooms?"".concat(e.bedrooms," bed"):"",s=e.bathrooms?"".concat(e.bathrooms," bath"):"",n=e.square_feet?"".concat(Number(e.square_feet).toLocaleString()," sq ft"):"",o=[i,s,n].filter(Boolean).join(" • ");return'\n                    <div style="padding: 12px; max-width: 280px;">\n                        <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">\n                            <a href="'.concat(e.permalink,'" style="color: #1f2937; text-decoration: none;">').concat(e.title,"</a>\n                        </h4>\n                        ").concat(t?'<div style="color: #2563eb; font-weight: 700; font-size: 18px; margin-bottom: 8px;">'.concat(t,"</div>"):"","\n                        ").concat(o?'<div style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">'.concat(o,"</div>"):"",'\n                        <a href="').concat(e.permalink,'" style="color: #2563eb; text-decoration: none; font-size: 14px; font-weight: 600;">\n                            View Details →\n                        </a>\n                    </div>\n                ')}}});
