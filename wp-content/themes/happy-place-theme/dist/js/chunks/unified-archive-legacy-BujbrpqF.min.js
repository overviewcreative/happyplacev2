System.register([],function(t,i){"use strict";return{execute:function(){window.HPH&&HPH.register("archiveUnified",function(t){return{currentView:"grid",currentPage:1,isLoading:!1,hasMorePages:!0,currentFilters:{},elements:{},init:function(){if(document.body.classList.contains("hph-map-view"))return t.debug,void this.initMapView();this.cacheElements(),this.bindEvents(),this.initializeView(),this.loadSavedPreferences(),t.debug},cacheElements:function(){this.elements={viewButtons:document.querySelectorAll("[data-view]"),viewContents:document.querySelectorAll("[data-view-content]"),filterForm:document.querySelector("#hero-search-form, .hph-search-form"),sortSelect:document.querySelector("[data-sort-select], #listings-sort"),searchInput:document.querySelector("#hero-search-input"),loadMoreBtn:document.querySelector("[data-load-more]"),loadMoreSection:document.querySelector(".hph-load-more-section"),gridContainer:document.querySelector('[data-listings-container="grid"]'),listContainer:document.querySelector('[data-listings-container="list"]'),mapContainer:document.querySelector('[data-view-content="map"]'),resultsCount:document.querySelector(".hph-results-count"),resultsInfo:document.querySelector(".hph-results-info")}},bindEvents:function(){if(this.elements.viewButtons.forEach(t=>{HPH.events.on(t,"click",i=>{i.preventDefault();const n=t.dataset.view;this.switchView(n)})}),this.elements.filterForm&&HPH.events.on(this.elements.filterForm,"submit",t=>{t.preventDefault(),this.handleFilterSubmit()}),this.elements.sortSelect&&HPH.events.on(this.elements.sortSelect,"change",t=>{this.handleSortChange(t.target.value)}),this.elements.loadMoreBtn&&HPH.events.on(this.elements.loadMoreBtn,"click",t=>{t.preventDefault(),this.loadMoreListings()}),this.elements.searchInput){let t;HPH.events.on(this.elements.searchInput,"input",i=>{clearTimeout(t),t=setTimeout(()=>{this.handleSearchInput(i.target.value)},500)})}const t=document.querySelector(".hph-map-panel-close");t&&HPH.events.on(t,"click",t=>{t.preventDefault(),this.switchView("grid")})},switchView:function(t){if(this.currentView!==t){switch(this.currentView=t,this.elements.viewButtons.forEach(i=>{const n=i.dataset.view===t;i.classList.toggle("active",n),i.setAttribute("aria-pressed",n)}),this.elements.viewContents.forEach(i=>{const n=i.dataset.viewContent===t;i.classList.toggle("active",n),i.style.display=n?"block":"none"}),t){case"map":return void this.redirectToMapView();case"grid":case"list":document.body.classList.remove("hph-map-view-active"),this.showElementsForStandardViews()}this.saveViewPreference(t),HPH.events.trigger(document,"hph:viewChanged",{view:t})}},handleFilterSubmit:function(){if(this.isLoading)return;const t=new FormData(this.elements.filterForm),i={};for(let[n,e]of t.entries())e&&""!==e&&(i[n]=e);this.currentFilters=i,this.currentPage=1,this.loadListings({reset:!0})},handleSortChange:function(t){this.isLoading||(this.currentFilters.sort=t,this.currentPage=1,this.loadListings({reset:!0}))},handleSearchInput:function(t){this.isLoading||(t.length>=3||0===t.length)&&(this.currentFilters.s=t,this.currentPage=1,this.loadListings({reset:!0}))},loadMoreListings:function(){!this.isLoading&&this.hasMorePages&&(this.currentPage++,this.loadListings({append:!0}))},loadListings:function(t={}){if(this.isLoading)return;this.isLoading=!0,this.showLoadingState(t.reset);const i={action:"hph_load_listings_unified",nonce:window.hphArchive?.nonce||"",page:this.currentPage,view:this.currentView,post_type:"listing",...this.currentFilters};fetch(window.hphArchive?.ajaxUrl||"/wp-admin/admin-ajax.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(i)}).then(t=>t.json()).then(i=>{this.handleAjaxResponse(i,t)}).catch(t=>{this.showError("Failed to load listings. Please try again.")}).finally(()=>{this.isLoading=!1,this.hideLoadingState()})},handleAjaxResponse:function(t,i){if(!t.success)return void this.showError(t.data?.message||"Failed to load listings");const{html:n,pagination:e,count:o,view:s}=t.data;i.reset?this.replaceListings(n,s):i.append&&this.appendListings(n,s),this.updatePagination(e),this.updateResultsCount(o),this.updateURL(),HPH.events.trigger(document,"hph:listingsLoaded",{view:s,count:o,page:this.currentPage})},replaceListings:function(t,i){const n="list"===i?this.elements.listContainer:this.elements.gridContainer;n&&(n.innerHTML=t,this.initializeNewListings(n))},appendListings:function(t,i){const n="list"===i?this.elements.listContainer:this.elements.gridContainer;n&&(n.insertAdjacentHTML("beforeend",t),this.initializeNewListings(n))},initializeNewListings:function(t){t.querySelectorAll(".favorite-btn").forEach(t=>{t.dataset.initialized||(t.dataset.initialized="true",window.userSystem?.initFavoriteButtons&&window.userSystem.initFavoriteButtons())})},updatePagination:function(t){this.hasMorePages=t.has_more,this.elements.loadMoreBtn&&(this.elements.loadMoreBtn.style.display=this.hasMorePages?"block":"none"),this.elements.loadMoreSection&&(this.elements.loadMoreSection.style.display=this.hasMorePages?"block":"none")},updateResultsCount:function(t){if(this.elements.resultsCount&&(this.elements.resultsCount.textContent=t.total||"0"),this.elements.resultsInfo){const i=(this.currentPage-1)*(t.per_page||12)+1,n=Math.min(i+(t.per_page||12)-1,t.total||0);this.elements.resultsInfo.textContent=`${i}-${n} of ${t.total||0} properties`}},updateURL:function(){const t=new URL(window.location);Object.keys(this.currentFilters).forEach(i=>{this.currentFilters[i]?t.searchParams.set(i,this.currentFilters[i]):t.searchParams.delete(i)}),t.searchParams.set("view",this.currentView),window.history.replaceState({},"",t.toString())},showLoadingState:function(t=!1){if(this.elements.loadMoreBtn){const t=this.elements.loadMoreBtn.querySelector(".hph-load-more-loading"),i=this.elements.loadMoreBtn.querySelector(".hph-load-more-text");t&&i&&(t.style.display="inline",i.style.display="none"),this.elements.loadMoreBtn.disabled=!0}t&&document.body.classList.add("hph-archive-loading")},hideLoadingState:function(){if(this.elements.loadMoreBtn){const t=this.elements.loadMoreBtn.querySelector(".hph-load-more-loading"),i=this.elements.loadMoreBtn.querySelector(".hph-load-more-text");t&&i&&(t.style.display="none",i.style.display="inline"),this.elements.loadMoreBtn.disabled=!1}document.body.classList.remove("hph-archive-loading")},showError:function(t){const i=document.querySelector(".hph-archive-error");i&&i.remove();const n=document.createElement("div");n.className="hph-archive-error hph-alert hph-alert-error",n.innerHTML=`\n                    <i class="fas fa-exclamation-triangle"></i>\n                    <span>${t}</span>\n                    <button type="button" class="hph-alert-close" aria-label="Close">\n                        <i class="fas fa-times"></i>\n                    </button>\n                `;const e=this.elements.gridContainer?.parentNode||document.querySelector(".hph-listings-container");if(e){e.insertBefore(n,e.firstChild),setTimeout(()=>{n.parentNode&&n.remove()},5e3);const t=n.querySelector(".hph-alert-close");HPH.events.on(t,"click",()=>{n.remove()})}},redirectToMapView:function(){if(document.body.classList.contains("hph-map-view")||window.location.search.includes("view=map"))return;const t=new URL(window.location);t.searchParams.set("view","map"),window.location.href=t.toString()},hideElementsForMapView:function(){document.querySelectorAll('[data-hide-in-views*="map"]').forEach(t=>{t.style.display="none"})},showElementsForStandardViews:function(){document.querySelectorAll('[data-hide-in-views*="map"]').forEach(t=>{t.style.display=""})},initializeView:function(){const t=new URLSearchParams(window.location.search).get("view");if(t&&["grid","list","map"].includes(t))this.switchView(t);else{const t=localStorage.getItem("hph_archive_view")||"grid";this.switchView(t)}},loadSavedPreferences:function(){try{const t=localStorage.getItem("hph_archive_view");t&&["grid","list","map"].includes(t)&&(this.currentView=t)}catch(t){}},saveViewPreference:function(t){try{localStorage.setItem("hph_archive_view",t)}catch(i){}},initMapView:function(){t.debug,window.HPHArchiveMap={initializeMapView:()=>{this.initializeMapView()}},this.elements.mapContainer=document.getElementById("mapbox-listings-map"),this.elements.mapCards=document.querySelectorAll(".hph-map-card"),t.debug},initializeMapView:function(){t.debug;const i=this.elements.mapContainer||document.getElementById("mapbox-listings-map");i&&"undefined"!=typeof mapboxgl&&window.hph_mapbox_config&&window.hph_mapbox_config.access_token&&window.hphArchiveMap&&("undefined"!=typeof HPHMap?this.initializeClusteredMap(i):this.initializeFallbackMap(i))},initializeClusteredMap:function(i){const n=window.hphArchiveMap,e=n.listings||[],o=n.center||[-75.1398,38.7816];try{const s=new HPHMap(i,{center:o,zoom:11,styleTheme:"professional",markerTheme:"happyPlace"});s.map.on("load",()=>{t.debug,s.addListingMarkers(e,{enableClustering:!1!==n.enable_clustering,clusterRadius:n.cluster_radius||50,clusterMaxZoom:n.cluster_max_zoom||14,showPopup:!0,fitBounds:e.length>1});const o=i.querySelector(".hph-map-loading");o&&(o.style.display="none"),this.setupMapSidebarSync(s),t.debug}),this.mapInstance=s}catch(s){this.initializeFallbackMap(i)}},initializeFallbackMap:function(t){const i=window.hphArchiveMap,n=i.listings||[],e=i.center||[-75.1398,38.7816];try{mapboxgl.accessToken=window.hph_mapbox_config.access_token;const i=new mapboxgl.Map({container:t,style:"mapbox://styles/mapbox/light-v11",center:e,zoom:11});i.on("load",()=>{n.forEach(t=>{if(t.latitude&&t.longitude){const n=new mapboxgl.Marker({color:"#2563eb"}).setLngLat([t.longitude,t.latitude]).addTo(i),e=new mapboxgl.Popup({offset:25}).setHTML(this.createPopupHTML(t));n.setPopup(e)}});const e=t.querySelector(".hph-map-loading");e&&(e.style.display="none")})}catch(o){}},setupMapSidebarSync:function(t){const i=this.elements.mapCards||document.querySelectorAll(".hph-map-card");i.forEach(n=>{n.addEventListener("click",e=>{const o=n.dataset.listingId;i.forEach(t=>t.classList.remove("active")),n.classList.add("active"),t&&t.highlightListingMarker&&t.highlightListingMarker(o)})}),document.addEventListener("hph-map-listing-click",t=>{const n=t.detail.listingId,e=document.querySelector(`[data-listing-id="${n}"]`);e&&(i.forEach(t=>t.classList.remove("active")),e.classList.add("active"),e.scrollIntoView({behavior:"smooth",block:"nearest"}))})},createPopupHTML:function(t){const i=t.price?`$${Number(t.price).toLocaleString()}`:"",n=[t.bedrooms?`${t.bedrooms} bed`:"",t.bathrooms?`${t.bathrooms} bath`:"",t.square_feet?`${Number(t.square_feet).toLocaleString()} sq ft`:""].filter(Boolean).join(" • ");return`\n                    <div style="padding: 12px; max-width: 280px;">\n                        <h4 style="margin: 0 0 8px 0; font-size: 16px; font-weight: 600;">\n                            <a href="${t.permalink}" style="color: #1f2937; text-decoration: none;">${t.title}</a>\n                        </h4>\n                        ${i?`<div style="color: #2563eb; font-weight: 700; font-size: 18px; margin-bottom: 8px;">${i}</div>`:""}\n                        ${n?`<div style="color: #6b7280; font-size: 14px; margin-bottom: 12px;">${n}</div>`:""}\n                        <a href="${t.permalink}" style="color: #2563eb; text-decoration: none; font-size: 14px; font-weight: 600;">\n                            View Details →\n                        </a>\n                    </div>\n                `}}})}}});
